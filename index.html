<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opulence Construction Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem 1.5rem;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 2rem;
            text-align: center;
        }

        .nav-item {
            padding: 1rem 1.2rem;
            margin: 0.5rem 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .nav-item:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .nav-item i {
            margin-right: 0.8rem;
            width: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .view-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Vapi Widget Styling */
        vapi-widget {
            position: fixed !important;
            bottom: 30px !important;
            right: 30px !important;
            z-index: 1000 !important;
        }
        
        /* Override default widget button styling to match dashboard */
        vapi-widget::part(button) {
            width: 70px !important;
            height: 70px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            border: none !important;
            color: white !important;
            font-size: 1.5rem !important;
            cursor: pointer !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4) !important;
            transition: all 0.3s ease !important;
        }
        
        vapi-widget::part(button):hover {
            transform: scale(1.1) !important;
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6) !important;
        }
        
        vapi-widget::part(button-active) {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24) !important;
            animation: pulse 1.5s infinite !important;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 12px 35px rgba(255, 107, 107, 0.6); }
            100% { transform: scale(1); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        }

        /* Dashboard Widgets */
        .widget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .widget {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .widget:hover {
            transform: translateY(-5px);
        }

        .widget h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .project-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            border-left: 4px solid #667eea;
        }

        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-delayed { background: #f8d7da; color: #721c24; }

        .crew-member {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            margin: 0.5rem 0;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
        }

        .crew-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 1rem;
        }

        .voice-status {
            position: fixed;
            top: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            display: none;
            z-index: 1001;
        }

        .voice-status.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo">OPULENCE</div>
            <nav>
                <div class="nav-item active" data-view="overview">
                    <i>üìä</i> Project Overview
                </div>
                <div class="nav-item" data-view="schedule">
                    <i>üìÖ</i> Master Schedule
                </div>
                <div class="nav-item" data-view="crew">
                    <i>üë•</i> Crew Management
                </div>
                <div class="nav-item" data-view="problems">
                    <i>‚ö†Ô∏è</i> Problem Resolution
                </div>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <div class="header">
                <div>
                    <h1 id="current-view-title">Project Overview</h1>
                    <p id="current-view-subtitle">Welcome back, Dan! Here's what's happening today.</p>
                </div>
                <div class="header-actions">
                    <span id="current-time"></span>
                </div>
            </div>

            <div class="view-content">
                <!-- Project Overview View -->
                <div id="overview" class="view-section active">
                    <div class="widget-grid">
                        <div class="widget">
                            <h3>Active Projects</h3>
                            <div class="project-card">
                                <h4>Johnson ADU Build</h4>
                                <p>225 Willow Creek Way, Olympia, WA</p>
                                <span class="status-badge status-active">In Progress</span>
                                <p><strong>Progress:</strong> 45% Complete</p>
                            </div>
                            <div class="project-card">
                                <h4>Smith Kitchen Remodel</h4>
                                <p>1842 Pine Street, Seattle, WA</p>
                                <span class="status-badge status-pending">Starting Soon</span>
                                <p><strong>Start Date:</strong> Aug 8, 2025</p>
                            </div>
                            <div class="project-card">
                                <h4>Brown Bathroom Addition</h4>
                                <p>567 Oak Avenue, Tacoma, WA</p>
                                <span class="status-badge status-delayed">Material Delay</span>
                                <p><strong>Issue:</strong> Tiles backordered</p>
                            </div>
                        </div>

                        <div class="widget">
                            <h3>Today's Tasks</h3>
                            <div style="padding: 1rem 0;">
                                <p><strong>üî® Johnson ADU:</strong> Framing inspection at 10:00 AM</p>
                                <p><strong>üèóÔ∏è Johnson ADU:</strong> Electrical rough-in starts at 2:00 PM</p>
                                <p><strong>üìã Smith Kitchen:</strong> Final permit approval expected</p>
                                <p><strong>üìû Brown Bathroom:</strong> Call supplier about tile delivery</p>
                            </div>
                        </div>

                        <div class="widget">
                            <h3>Crew Status</h3>
                            <div class="crew-member">
                                <div class="crew-avatar">B</div>
                                <div>
                                    <strong>Bob (Framing Lead)</strong><br>
                                    <small>Johnson ADU - Available after 3 PM</small>
                                </div>
                            </div>
                            <div class="crew-member">
                                <div class="crew-avatar">J</div>
                                <div>
                                    <strong>Jeff (Drywall)</strong><br>
                                    <small>Smith Kitchen - Starting tomorrow</small>
                                </div>
                            </div>
                            <div class="crew-member">
                                <div class="crew-avatar">M</div>
                                <div>
                                    <strong>Mike (Apprentice)</strong><br>
                                    <small>Johnson ADU - With Bob today</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule Management View -->
                <div id="schedule" class="view-section">
                    <h2>Master Schedule</h2>
                    <div class="widget-grid">
                        <div class="widget">
                            <h3>This Week's Schedule</h3>
                            <div style="padding: 1rem 0;">
                                <p><strong>Monday:</strong> Johnson ADU - Framing inspection, Electrical start</p>
                                <p><strong>Tuesday:</strong> Smith Kitchen - Demo begins</p>
                                <p><strong>Wednesday:</strong> Johnson ADU - Electrical continues</p>
                                <p><strong>Thursday:</strong> Johnson ADU - Plumbing rough-in</p>
                                <p><strong>Friday:</strong> Smith Kitchen - Framing</p>
                            </div>
                        </div>
                        <div class="widget">
                            <h3>Upcoming Milestones</h3>
                            <div style="padding: 1rem 0;">
                                <p><strong>Aug 15:</strong> Johnson ADU - Framing inspection deadline</p>
                                <p><strong>Aug 20:</strong> Smith Kitchen - Permit expires if not started</p>
                                <p><strong>Aug 25:</strong> Brown Bathroom - Client wants progress update</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Crew Management View -->
                <div id="crew" class="view-section">
                    <h2>Crew Management</h2>
                    <div class="widget-grid">
                        <div class="widget">
                            <h3>Available Crew</h3>
                            <div class="crew-member">
                                <div class="crew-avatar">B</div>
                                <div>
                                    <strong>Bob Martinez - Lead Framer</strong><br>
                                    <small>Skills: Framing, Carpentry | Available: After 3 PM today</small>
                                </div>
                            </div>
                            <div class="crew-member">
                                <div class="crew-avatar">J</div>
                                <div>
                                    <strong>Jeff Thompson - Drywall Specialist</strong><br>
                                    <small>Skills: Drywall, Painting | Available: Tomorrow morning</small>
                                </div>
                            </div>
                            <div class="crew-member">
                                <div class="crew-avatar">M</div>
                                <div>
                                    <strong>Mike Chen - Apprentice</strong><br>
                                    <small>Skills: General Labor | Available: Now (with supervision)</small>
                                </div>
                            </div>
                        </div>

                        <div class="widget">
                            <h3>Subcontractors</h3>
                            <div style="padding: 1rem 0;">
                                <p><strong>üí° Pacific Electric:</strong> Available Wed-Fri this week</p>
                                <p><strong>üöø Northwest Plumbing:</strong> Booked until Aug 12</p>
                                <p><strong>üè† Elite Roofing:</strong> Available for quotes</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Problem Resolution View -->
                <div id="problems" class="view-section">
                    <h2>Problem Resolution</h2>
                    <div class="widget-grid">
                        <div class="widget">
                            <h3>Active Issues</h3>
                            <div class="project-card">
                                <h4>Brown Bathroom - Material Delay</h4>
                                <span class="status-badge status-delayed">High Priority</span>
                                <p><strong>Issue:</strong> Subway tiles backordered 2 weeks</p>
                                <p><strong>Options:</strong> Find alternative supplier or reschedule crew</p>
                            </div>
                            <div class="project-card">
                                <h4>Weather Alert - Tuesday</h4>
                                <span class="status-badge status-pending">Monitor</span>
                                <p><strong>Issue:</strong> Heavy rain forecasted</p>
                                <p><strong>Impact:</strong> May delay Smith Kitchen demo</p>
                            </div>
                        </div>

                        <div class="widget">
                            <h3>Resolution Tools</h3>
                            <div style="padding: 1rem 0;">
                                <p><strong>üîÑ Auto-Reschedule:</strong> Automatically handle weather delays</p>
                                <p><strong>üìû Supplier Alerts:</strong> Get notified of material issues</p>
                                <p><strong>üë• Crew Optimization:</strong> Reassign workers when tasks finish early</p>
                                <p><strong>üìã Client Updates:</strong> Automated progress notifications</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Voice Assistant -->
    <div class="voice-assistant">
        <!-- Vapi Widget Integration -->
        <vapi-widget 
            assistant-id="d2572015-8bb2-4043-8913-87400a590bc5" 
            public-key="1f96e572-7a5b-4b45-ba8b-0dc2721ca738"
            style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
        </vapi-widget>
    </div>

    <!-- Voice Status Indicator -->
    <div class="voice-status" id="voiceStatus">
        Listening... Speak now!
    </div>

    <!-- Vapi Widget SDK -->
    <script
        src="https://unpkg.com/@vapi-ai/client-sdk-react/dist/embed/widget.umd.js"
        async
        type="text/javascript">
    </script>
    
    <script>
        // Vapi Widget Integration and Dashboard Control
        let vapiWidget = null;
        
        // Wait for Vapi widget to load and initialize dashboard integration
        document.addEventListener('DOMContentLoaded', function() {
            // Give the widget time to load
            setTimeout(initializeVapiIntegration, 2000);
        });
        
        function initializeVapiIntegration() {
            // The widget handles all voice functionality automatically
            // We just need to listen for any custom events or messages
            
            console.log('Vapi widget loaded and ready');
            
            // Optional: Listen for widget events if available
            // This depends on what events the widget exposes
            window.addEventListener('message', function(event) {
                // Handle any messages from the Vapi widget
                if (event.data && event.data.type === 'vapi-widget') {
                    console.log('Vapi widget message:', event.data);
                    handleVapiWidgetMessage(event.data);
                }
            });
        }
        
        function handleVapiWidgetMessage(data) {
            // Handle messages from the Vapi widget
            // This could include conversation events, function calls, etc.
            
            switch(data.event) {
                case 'call-start':
                    console.log('Voice call started');
                    showVoiceStatus('Connected to AI assistant...');
                    break;
                    
                case 'call-end':
                    console.log('Voice call ended');
                    hideVoiceStatus();
                    break;
                    
                case 'assistant-response':
                    if (data.message) {
                        processAssistantResponse(data.message);
                    }
                    break;
                    
                default:
                    console.log('Unknown widget event:', data.event);
            }
        }
        
        // Dashboard control functions that the voice assistant can trigger
        function processAssistantResponse(message) {
            const response = message.toLowerCase();
            
            // Parse assistant responses for dashboard commands
            if (response.includes('showing') || response.includes('here') || response.includes('displaying')) {
                if (response.includes('schedule') || response.includes('calendar')) {
                    switchView('schedule');
                    showVoiceStatus('Showing master schedule');
                } else if (response.includes('crew') || response.includes('team') || response.includes('workers')) {
                    switchView('crew');
                    showVoiceStatus('Showing crew management');
                } else if (response.includes('problem') || response.includes('issue') || response.includes('delay')) {
                    switchView('problems');
                    showVoiceStatus('Showing problem resolution');
                } else if (response.includes('overview') || response.includes('project')) {
                    switchView('overview');
                    showVoiceStatus('Showing project overview');
                }
            }
            
            // Handle specific project mentions
            if (response.includes('johnson') || response.includes('adu')) {
                switchView('overview');
                highlightProject('johnson-adu');
                showVoiceStatus('Highlighting Johnson ADU project');
            } else if (response.includes('smith') || response.includes('kitchen')) {
                switchView('overview');
                highlightProject('smith-kitchen');
                showVoiceStatus('Highlighting Smith kitchen project');
            } else if (response.includes('brown') || response.includes('bathroom')) {
                switchView('overview');
                highlightProject('brown-bathroom');
                showVoiceStatus('Highlighting Brown bathroom project');
            }
            
            // Handle crew member queries
            if (response.includes('bob')) {
                switchView('crew');
                highlightCrewMember('bob');
                showVoiceStatus('Showing Bob\'s information');
            } else if (response.includes('jeff')) {
                switchView('crew');
                highlightCrewMember('jeff');
                showVoiceStatus('Showing Jeff\'s information');
            } else if (response.includes('mike')) {
                switchView('crew');
                highlightCrewMember('mike');
                showVoiceStatus('Showing Mike\'s information');
            }
        }
        
        function showVoiceStatus(message) {
            const voiceStatus = document.getElementById('voiceStatus');
            if (voiceStatus) {
                voiceStatus.textContent = message;
                voiceStatus.classList.add('show');
                setTimeout(() => voiceStatus.classList.remove('show'), 3000);
            }
        }
        
        function hideVoiceStatus() {
            const voiceStatus = document.getElementById('voiceStatus');
            if (voiceStatus) {
                voiceStatus.classList.remove('show');
            }
        }

        // Dashboard Navigation
        const navItems = document.querySelectorAll('.nav-item');
        const viewSections = document.querySelectorAll('.view-section');
        const viewTitle = document.getElementById('current-view-title');
        const viewSubtitle = document.getElementById('current-view-subtitle');

        const viewData = {
            overview: {
                title: 'Project Overview',
                subtitle: 'Welcome back, Dan! Here\'s what\'s happening today.'
            },
            schedule: {
                title: 'Master Schedule',
                subtitle: 'Manage your project timelines and crew assignments.'
            },
            crew: {
                title: 'Crew Management',
                subtitle: 'Track your team and subcontractor availability.'
            },
            problems: {
                title: 'Problem Resolution',
                subtitle: 'Address issues and keep projects on track.'
            }
        };

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetView = item.dataset.view;
                switchView(targetView);
            });
        });

        function switchView(viewName) {
            // Update active nav item
            navItems.forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');

            // Update active view section
            viewSections.forEach(section => section.classList.remove('active'));
            document.getElementById(viewName).classList.add('active');

            // Update header
            const data = viewData[viewName];
            viewTitle.textContent = data.title;
            viewSubtitle.textContent = data.subtitle;

            // Log view change for voice agent integration
            console.log(`Dashboard switched to: ${viewName}`);
        }

        // Initialize Vapi when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeVapi();
        });

        function initializeVapi() {
            try {
                vapi = new Vapi(VAPI_PUBLIC_KEY);
                
                // Vapi event listeners
                vapi.on('call-start', () => {
                    console.log('Vapi call started');
                    isVapiConnected = true;
                    voiceButton.classList.add('listening');
                    voiceButton.innerHTML = 'üî¥';
                    voiceStatus.textContent = 'Connected to AI assistant...';
                    voiceStatus.classList.add('show');
                });
                
                vapi.on('call-end', () => {
                    console.log('Vapi call ended');
                    isVapiConnected = false;
                    voiceButton.classList.remove('listening');
                    voiceButton.innerHTML = 'üé§';
                    voiceStatus.classList.remove('show');
                });
                
                vapi.on('speech-start', () => {
                    console.log('User started speaking');
                    voiceStatus.textContent = 'Listening...';
                });
                
                vapi.on('speech-end', () => {
                    console.log('User stopped speaking');
                    voiceStatus.textContent = 'Processing...';
                });
                
                vapi.on('message', (message) => {
                    console.log('Vapi message:', message);
                    
                    // Handle function calls from the assistant
                    if (message.type === 'function-call') {
                        handleVapiFunction(message);
                    }
                    
                    // Handle assistant responses
                    if (message.type === 'transcript' && message.role === 'assistant') {
                        voiceStatus.textContent = message.transcript;
                        processAssistantResponse(message.transcript);
                    }
                });
                
                vapi.on('error', (error) => {
                    console.error('Vapi error:', error);
                    voiceStatus.textContent = 'Voice assistant error. Please try again.';
                    stopVapiCall();
                });
                
                console.log('Vapi initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize Vapi:', error);
                // Fall back to browser speech recognition
                initializeBrowserSpeechRecognition();
            }
        }

        function startVapiCall() {
            if (!vapi) {
                console.error('Vapi not initialized');
                return;
            }
            
            try {
                vapi.start({
                    assistantId: ASSISTANT_ID,
                    // Optional: Add assistant overrides
                    assistant: {
                        // You can override assistant settings here if needed
                        firstMessage: "Hey there! I'm your Opulence construction assistant. What do you need help with today?",
                    }
                });
            } catch (error) {
                console.error('Error starting Vapi call:', error);
                voiceStatus.textContent = 'Failed to connect to voice assistant';
                voiceStatus.classList.add('show');
            }
        }
        
        function stopVapiCall() {
            if (vapi && isVapiConnected) {
                vapi.stop();
            }
        }
        
        // Handle function calls from Vapi assistant
        function handleVapiFunction(message) {
            const functionName = message.functionCall?.name;
            const parameters = message.functionCall?.parameters;
            
            console.log('Assistant function call:', functionName, parameters);
            
            // Dashboard control functions
            switch (functionName) {
                case 'switch_dashboard_view':
                    if (parameters?.view) {
                        switchView(parameters.view);
                    }
                    break;
                    
                case 'highlight_project':
                    if (parameters?.projectName) {
                        highlightProjectByName(parameters.projectName);
                    }
                    break;
                    
                case 'show_crew_member':
                    if (parameters?.memberName) {
                        switchView('crew');
                        highlightCrewMember(parameters.memberName);
                    }
                    break;
                    
                default:
                    console.log('Unknown function call:', functionName);
            }
        }
        
        // Process assistant text responses for dashboard actions
        function processAssistantResponse(transcript) {
            const response = transcript.toLowerCase();
            
            // Extract dashboard commands from assistant responses
            if (response.includes('showing') || response.includes('here') || response.includes('displaying')) {
                if (response.includes('schedule')) {
                    switchView('schedule');
                } else if (response.includes('crew') || response.includes('team')) {
                    switchView('crew');
                } else if (response.includes('problem') || response.includes('issue')) {
                    switchView('problems');
                } else if (response.includes('overview') || response.includes('project')) {
                    switchView('overview');
                }
            }
        }

        // Voice Assistant Button Handler (Updated for Vapi)
        const voiceButton = document.getElementById('voiceButton');
        const voiceStatus = document.getElementById('voiceStatus');

        voiceButton.addEventListener('click', toggleVapiCall);

        function toggleVapiCall() {
            if (isVapiConnected) {
                stopVapiCall();
            } else {
                startVapiCall();
            }
        }

        // Fallback: Browser Speech Recognition (if Vapi fails)
        function initializeBrowserSpeechRecognition() {
            console.log('Falling back to browser speech recognition');
            
            // Your existing browser speech recognition code here
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    console.log('Browser speech recognition started');
                    voiceStatus.textContent = 'Listening... Speak now!';
                };
                
                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }
                    
                    if (finalTranscript) {
                        voiceStatus.textContent = `You said: "${finalTranscript}"`;
                        console.log('Final transcript:', finalTranscript);
                        processVoiceCommand(finalTranscript);
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    voiceStatus.textContent = `Error: ${event.error}`;
                };
                
                recognition.onend = function() {
                    console.log('Browser speech recognition ended');
                    voiceButton.classList.remove('listening');
                    voiceButton.innerHTML = 'üé§';
                };
                
                // Update button handler for fallback mode
                voiceButton.removeEventListener('click', toggleVapiCall);
                voiceButton.addEventListener('click', function() {
                    if (recognition) {
                        voiceButton.classList.add('listening');
                        voiceButton.innerHTML = 'üî¥';
                        voiceStatus.classList.add('show');
                        recognition.start();
                    }
                });
            }
        }

        // Helper function for highlighting projects by name
        function highlightProjectByName(projectName) {
            const name = projectName.toLowerCase();
            if (name.includes('johnson') || name.includes('adu')) {
                switchView('overview');
                highlightProject('johnson-adu');
            } else if (name.includes('smith') || name.includes('kitchen')) {
                switchView('overview');
                highlightProject('smith-kitchen');
            } else if (name.includes('brown') || name.includes('bathroom')) {
                switchView('overview');
                highlightProject('brown-bathroom');
            }
        }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = function() {
                console.log('Speech recognition started');
                voiceStatus.textContent = 'Listening... Speak now!';
            };
            
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Show interim results
                if (interimTranscript) {
                    voiceStatus.textContent = `Hearing: "${interimTranscript}"`;
                }
                
                // Process final result
                if (finalTranscript) {
                    voiceStatus.textContent = `You said: "${finalTranscript}"`;
                    console.log('Final transcript:', finalTranscript);
                    processVoiceCommand(finalTranscript);
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                let errorMessage = 'Speech recognition error: ';
                
                switch(event.error) {
                    case 'not-allowed':
                        errorMessage = 'Microphone access denied. Please allow microphone access in your browser settings.';
                        break;
                    case 'no-speech':
                        errorMessage = 'No speech detected. Try speaking closer to your microphone.';
                        break;
                    case 'audio-capture':
                        errorMessage = 'Microphone not found. Please check your microphone connection.';
                        break;
                    case 'network':
                        errorMessage = 'Network error occurred. Please check your internet connection.';
                        break;
                    default:
                        errorMessage += event.error;
                }
                
                voiceStatus.textContent = errorMessage;
                stopListening();
                
                // Keep error message visible longer
                setTimeout(() => voiceStatus.classList.remove('show'), 5000);
            };
            
            recognition.onend = function() {
                console.log('Speech recognition ended');
                if (isListening) {
                    stopListening();
                }
            };
        } else {
            console.warn('Speech recognition not supported in this browser');
        }

        voiceButton.addEventListener('click', toggleVoiceListening);

        function toggleVoiceListening() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            if (!recognition) {
                voiceStatus.textContent = 'Speech recognition not supported in this browser';
                voiceStatus.classList.add('show');
                setTimeout(() => voiceStatus.classList.remove('show'), 3000);
                return;
            }
            
            // Request microphone permission first
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    // Permission granted, stop the stream and start recognition
                    stream.getTracks().forEach(track => track.stop());
                    
                    isListening = true;
                    voiceButton.classList.add('listening');
                    voiceButton.innerHTML = 'üî¥';
                    voiceStatus.classList.add('show');
                    
                    try {
                        recognition.start();
                        console.log('Voice listening started');
                    } catch (error) {
                        console.error('Error starting recognition:', error);
                        stopListening();
                    }
                })
                .catch(function(error) {
                    console.error('Microphone permission denied:', error);
                    voiceStatus.textContent = 'Microphone access denied. Please allow microphone access and try again.';
                    voiceStatus.classList.add('show');
                    setTimeout(() => voiceStatus.classList.remove('show'), 5000);
                });
        }

        function stopListening() {
            isListening = false;
            voiceButton.classList.remove('listening');
            voiceButton.innerHTML = 'üé§';
            
            if (recognition) {
                recognition.stop();
            }
            
            setTimeout(() => {
                voiceStatus.classList.remove('show');
            }, 2000);
            
            console.log('Voice listening stopped');
        }

        // Process voice commands and route to appropriate actions
        function processVoiceCommand(transcript) {
            const command = transcript.toLowerCase().trim();
            console.log('Processing voice command:', command);
            
            // Dashboard navigation commands
            if (command.includes('overview') || command.includes('project overview') || command.includes('dashboard')) {
                switchView('overview');
                respondToUser('Showing project overview');
            }
            else if (command.includes('schedule') || command.includes('master schedule') || command.includes('calendar')) {
                switchView('schedule');
                respondToUser('Showing master schedule');
            }
            else if (command.includes('crew') || command.includes('team') || command.includes('workers')) {
                switchView('crew');
                respondToUser('Showing crew management');
            }
            else if (command.includes('problem') || command.includes('issue') || command.includes('delay') || command.includes('resolution')) {
                switchView('problems');
                respondToUser('Showing problem resolution');
            }
            
            // Specific project queries
            else if (command.includes('johnson') || command.includes('adu')) {
                switchView('overview');
                highlightProject('johnson-adu');
                respondToUser('Here\'s the Johnson ADU project details');
            }
            else if (command.includes('smith') || command.includes('kitchen')) {
                switchView('overview');
                highlightProject('smith-kitchen');
                respondToUser('Here\'s the Smith kitchen remodel project');
            }
            else if (command.includes('brown') || command.includes('bathroom')) {
                switchView('overview');
                highlightProject('brown-bathroom');
                respondToUser('Here\'s the Brown bathroom addition project');
            }
            
            // Crew-specific queries
            else if (command.includes('bob') || command.includes('where is bob')) {
                switchView('crew');
                highlightCrewMember('bob');
                respondToUser('Bob is currently at the Johnson ADU site doing framing work');
            }
            else if (command.includes('jeff') || command.includes('where is jeff')) {
                switchView('crew');
                highlightCrewMember('jeff');
                respondToUser('Jeff is preparing for the Smith kitchen project starting tomorrow');
            }
            else if (command.includes('mike') || command.includes('where is mike')) {
                switchView('crew');
                highlightCrewMember('mike');
                respondToUser('Mike is working with Bob at the Johnson ADU site today');
            }
            
            // Status queries
            else if (command.includes('what\'s happening today') || command.includes('today\'s tasks') || command.includes('what do we have today')) {
                switchView('overview');
                highlightTodaysTasks();
                respondToUser('Here are today\'s scheduled tasks and activities');
            }
            else if (command.includes('any problems') || command.includes('issues') || command.includes('delays')) {
                switchView('problems');
                respondToUser('Here are the current issues that need attention');
            }
            
            // Default response
            else {
                respondToUser('I heard you say: "' + transcript + '". How can I help you with your construction projects?');
            }
        }

        // Provide audio feedback to user
        function respondToUser(message) {
            voiceStatus.textContent = message;
            console.log('AI Response:', message);
            
            // Use speech synthesis to respond
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                speechSynthesis.speak(utterance);
            }
        }

        // Helper functions for highlighting specific items
        function highlightProject(projectId) {
            // Add visual highlighting for specific projects
            const projectCards = document.querySelectorAll('.project-card');
            projectCards.forEach(card => card.style.boxShadow = '');
            
            // This would be enhanced to highlight specific projects based on ID
            if (projectCards.length > 0) {
                const targetIndex = projectId.includes('johnson') ? 0 : projectId.includes('smith') ? 1 : 2;
                if (projectCards[targetIndex]) {
                    projectCards[targetIndex].style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.6)';
                    projectCards[targetIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function highlightCrewMember(memberName) {
            const crewMembers = document.querySelectorAll('.crew-member');
            crewMembers.forEach(member => member.style.boxShadow = '');
            
            const memberIndex = memberName.includes('bob') ? 0 : memberName.includes('jeff') ? 1 : 2;
            if (crewMembers[memberIndex]) {
                crewMembers[memberIndex].style.boxShadow = '0 0 15px rgba(102, 126, 234, 0.5)';
                crewMembers[memberIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function highlightTodaysTasks() {
            const tasksWidget = document.querySelector('.widget h3');
            if (tasksWidget && tasksWidget.textContent === "Today's Tasks") {
                const widget = tasksWidget.closest('.widget');
                widget.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.6)';
                widget.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                setTimeout(() => {
                    widget.style.boxShadow = '';
                }, 5000);
            }
        }

        // Voice Agent Integration Functions (Updated for Vapi)
        window.dashboardControl = {
            switchView: switchView,
            getCurrentView: () => {
                const activeNav = document.querySelector('.nav-item.active');
                return activeNav ? activeNav.dataset.view : 'overview';
            },
            updateProjectData: (data) => {
                console.log('Updating project data:', data);
                // This will be connected to real data updates from n8n
            },
            showNotification: (message) => {
                voiceStatus.textContent = message;
                voiceStatus.classList.add('show');
                setTimeout(() => voiceStatus.classList.remove('show'), 3000);
            },
            // New Vapi integration functions
            startVoiceCall: startVapiCall,
            stopVoiceCall: stopVapiCall,
            isVoiceConnected: () => isVapiConnected
        };
